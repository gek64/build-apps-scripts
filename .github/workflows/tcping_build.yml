name: tcping build

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: Setup golang
        uses: actions/setup-go@v2
        with:
          go-version: '^1.17'

      - name: Build
        run: |
          rm -rf tcping/*

          mkdir -p tmp
          cd tmp || exit

          # 下载待编译源代码
          git clone https://github.com/cloverstd/tcping.git
          cd tcping || exit

          # 下载编译脚本并编译所有支持的架构/系统对
          curl -LOJ https://github.com/gek64/build-apps-scripts/raw/main/gobuilder.sh
          bash gobuilder.sh --os linux --arch amd64

          # 下载源代码
          cd bin || exit
          curl -LOJ https://github.com/cloverstd/tcping/archive/refs/heads/master.zip

          cd ../../..
          mv tmp/tcping/bin/* tcping/
          rm -rf tmp

          git config user.name "${{ github.actor }}"
          git config user.email "${{ github.actor }}@users.noreply.github.com"
          git remote add origin "https://${{ github.actor }}:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}"
          git commit -m "$(date +"%Y.%m.%d")"
          git push -u origin master
